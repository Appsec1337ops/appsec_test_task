name: Security Pipeline

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  appsec:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        distribution: temurin
        java-version: '17'

    - name: Build App (Gradle)
      run: ./gradlew build -x test

    # SEMGREP — не ломает pipeline, сохраняет отчёт
    - name: Run Semgrep and save report
      run: |
        pip install semgrep
        semgrep --config=auto --json > semgrep-report.json || true
        mkdir -p semgrep-report
        semgrep --config=auto --html > semgrep-report/semgrep.html || true

    - name: Upload Semgrep report artifact
      uses: actions/upload-artifact@v3
      with:
        name: semgrep-report
        path: semgrep-report/

    # GITLEAKS
    - name: Gitleaks (секреты)
      uses: gitleaks/gitleaks-action@v2
      env:
        GITLEAKS_LICENSE: accept
      continue-on-error: true

    # DEPENDENCY-CHECK
    - name: OWASP Dependency Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: "dvsb-app"
        path: "."
        format: "HTML"
      continue-on-error: true

    # ZAP DAST
    - name: OWASP ZAP Baseline Scan
      uses: zaproxy/action-baseline@v0.10.0
      with:
        target: 'http://localhost:8080'
      continue-on-error: true
