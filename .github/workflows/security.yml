name: AppSec CI

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  appsec:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source
      uses: actions/checkout@v3

    - name: Set up Java 17
      uses: actions/setup-java@v3
      with:
        distribution: temurin
        java-version: '17'

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install security tools
      run: |
        pip install semgrep
        curl -sSL https://github.com/gitleaks/gitleaks/releases/latest/download/gitleaks-linux-amd64 -o gitleaks
        chmod +x gitleaks && sudo mv gitleaks /usr/local/bin/

    - name: Build the app
      run: |
        mvn clean package -DskipTests
        java -jar target/*.jar &
        sleep 15

    - name: Semgrep (SAST)
      run: semgrep --config=auto .

    - name: Gitleaks (секреты)
      run: gitleaks detect --source=. --no-git || true

    - name: Dependency-Check (SCA)
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: "DamnVulnerableSpringApp"
        path: "."
        format: "HTML"

    - name: OWASP ZAP (DAST)
      uses: zaproxy/action-baseline@v0.10.0
      with:
        target: 'http://localhost:8080'
      continue-on-error: true
